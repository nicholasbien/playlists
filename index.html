<!DOCTYPE html>
<html>
<head>
    <title>Spotify Playlist Generator</title>
    <link rel="stylesheet" href="site.css">
</head>
<body>
    <h1>Spotify Playlist Generator</h1>
    <form onsubmit="authorizeUser()">
        <label>Artist:</label>
        <input id="artist">
        <input type="submit">
    </form>
    <p id="status"></p>
    <div>
        <a id="link" target="_blank"></a>
    </div>
    <iframe id="player" width="250px" height="330px" frameborder="0" allowtransparency="true"></iframe>
</body>
<script>
    
    function getPlaylist(access_token) {
        getUsername(access_token);
    }

    function getUsername(access_token) {
        var request = new XMLHttpRequest();
        request.open('GET', 'https://api.spotify.com/v1/me');
        request.setRequestHeader('Authorization', 'Bearer ' + access_token);
        request.addEventListener('load', function() {
            var response = JSON.parse(this.responseText);
            createPlaylist(access_token, response.id);
        });
        request.send();
    }

    function createPlaylist(access_token, userId) {
        var request = new XMLHttpRequest();
        request.open('POST', 'https://api.spotify.com/v1/users/' + userId + '/playlists');
        request.setRequestHeader('Authorization', 'Bearer ' + access_token);
        request.setRequestHeader('Content-Type', 'application/json');
        
        request.addEventListener('load', function() {
            var response = JSON.parse(this.responseText);
            getSpotifyURIs(userId, response.id, access_token);
        });
        
        var artistQuery = localStorage.getItem('artistQuery');
        var body = JSON.stringify({
            'name': artistQuery,
            'public': false
        });
        request.send(body);
        
    }

    function getSpotifyURIs(userId, playlistId, access_token) {
        var artistQuery = localStorage.getItem('artistQuery');

        var request = new XMLHttpRequest();
        request.open('GET', 'http://developer.echonest.com/api/v4/playlist/static?api_key=ABFI7P4WHSMYRUEJ4&artist=' + artistQuery + '&format=json&results=20&type=artist-radio&bucket=id:spotify&bucket=tracks');
        request.addEventListener('load', function() {
            var response = JSON.parse(request.responseText);
            var songs = response.response.songs;
            var spotifyURIs = songs.map(function(song) {
                var tracks = song.tracks;
                if (tracks.length === 0) {
                    return null;
                } else {
                    return tracks[0].foreign_id;
                }
            });
            spotifyURIs = spotifyURIs.filter(function(uri) {
                return uri !== null;
            });
            addTracks(userId, playlistId, spotifyURIs, access_token);
        });
        request.send();
    }

    

    function addTracks(userId, playlistId, spotifyURIs, access_token) {
        var request = new XMLHttpRequest();
        request.open('POST', 'https://api.spotify.com/v1/users/' + userId + '/playlists/' + playlistId + '/tracks');
        request.setRequestHeader('Authorization', 'Bearer ' + access_token);
        request.setRequestHeader('Content-Type', 'application/json');
        request.addEventListener('load', function() {
            var status = document.getElementById('status');
            status.innerHTML = 'Success! Your playlist has been added. ' + '<a href="https://open.spotify.com/user/' + userId + '/playlist/' + playlistId +'" target="_blank">View here<a>';
        });
        var body = JSON.stringify({
            'uris': spotifyURIs
        })
        request.send(body);
    }

    (function() {
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var access_token = params.access_token;
        var state = params.state;
        //var storedState = localStorage.getItem(stateKey);

        if (access_token) {
            var status = document.getElementById('status');
            status.innerHTML = 'Creating your playlist...';
            getPlaylist(access_token);
        }
            
    })();

    function authorizeUser() {
        event.preventDefault();

        var artist = document.getElementById('artist').value;
        var artistQuery = encodeURIComponent(artist);
        localStorage.setItem('artistQuery', artistQuery);

        window.location = 'https://accounts.spotify.com/authorize?client_id=999d4ee5cddc4a53aa942ac43799a5f8&response_type=token&scope=playlist-modify-private&redirect_uri=' + window.location.origin + '&show_dialog=true';
    }

</script>
</html>