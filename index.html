<!DOCTYPE html>
<html>
<head>
    <title>Spotify Playlist Generator</title>
</head>
<body>
    <h1>Spotify Playlist Generator</h1>
    <form onsubmit="authorizeUser(event)">
        <label>Artist:</label>
        <input id="artist">
        <input type="submit">
    </form>
    <p id="status"></p>
</body>
<script>

    function authorizeUser(event) {
        event.preventDefault();

        var artist = document.getElementById('artist').value;
        localStorage.setItem('artist', artist);

        window.location = 'https://accounts.spotify.com/authorize?client_id=999d4ee5cddc4a53aa942ac43799a5f8&response_type=token&scope=playlist-modify-private&redirect_uri=' + encodeURIComponent(window.location.origin) + '&show_dialog=true';
    }

    var SpotifyAPI = {};

    SpotifyAPI.timeout = 10000;

    SpotifyAPI.getUserId = function(accessToken, callback) {
        var url = 'https://api.spotify.com/v1/me';
        var xhr = new XMLHttpRequest();
        xhr.ontimeout = function() {
            callback('The request timed out. Please try again');
        };
        xhr.onload = function() {
            if (xhr.status !== 200) {
                callback(xhr.responseText);
            } else {
                var response = JSON.parse(this.responseText);
                callback(null, response.id);
            }
        };
        xhr.open('GET', url);
        xhr.timeout = SpotifyAPI.timeout;
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.send();
    }

    SpotifyAPI.createPlaylist = function(accessToken, userId, playlistName, callback) {
        var url = 'https://api.spotify.com/v1/users/' + userId + '/playlists';
        var xhr = new XMLHttpRequest();
        xhr.ontimeout = function() {
            callback('The request timed out. Please try again');
        };
        xhr.onload = function() {
            if (xhr.status !== 200 && xhr.status !== 201) {
                callback(xhr.responseText);
            } else {
                var response = JSON.parse(this.responseText);
                callback(null, response.id);
            }
        };
        xhr.open('POST', url);
        xhr.timeout = SpotifyAPI.timeout;
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.setRequestHeader('Content-Type', 'application/json');
        var body = JSON.stringify({
            'name': playlistName,
            'public': false
        });
        xhr.send(body);
    }

    SpotifyAPI.addTracksToPlaylist = function(accessToken, userId, playlistId, spotifyURIs, callback) {
        var xhr = new XMLHttpRequest();
        var url = 'https://api.spotify.com/v1/users/' + userId + '/playlists/' + playlistId + '/tracks';
        xhr.ontimeout = function() {
            callback('The request timed out. Please try again');
        };
        xhr.onload = function() {
            if (xhr.status !== 200 && xhr.status !== 201) {
                return callback(xhr.responseText);
            } else {
                callback(null);
            }
        };
        xhr.open('POST', url);
        xhr.timeout = SpotifyAPI.timeout;
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.setRequestHeader('Content-Type', 'application/json');
        var body = JSON.stringify({
            'uris': spotifyURIs
        });
        xhr.send(body);
    };

    var EchoNestAPI = {};

    EchoNestAPI.timeout = 10000;
    
    EchoNestAPI.getArtistRadio = function(artistQuery, numResults, callback) {
        var url = 'http://developer.echonest.com/api/v4/playlist/static'
            + '?api_key=ABFI7P4WHSMYRUEJ4'
            + '&artist=' + artistQuery
            + '&results=' + numResults
            + '&type=artist-radio'
            + '&bucket=id:spotify'
            + '&bucket=tracks';
        var xhr = new XMLHttpRequest();
        xhr.ontimeout = function() {
            callback('The request timed out. Please try again');
        };
        xhr.onload = function() {
            if (xhr.status !== 200) {
                return callback(xhr.responseText);
            } else {
                var response = JSON.parse(xhr.responseText);
                if (response.response.status.code === 5) {
                    callback('That artist could not be found. Please try again.');
                } else {
                    var songs = response.response.songs;
                    var spotifyURIs = songs.map(function(song) {
                        var tracks = song.tracks;
                        if (tracks.length === 0) {
                            return null;
                        } else {
                            return tracks[0].foreign_id;
                        }
                    });
                    spotifyURIs = spotifyURIs.filter(function(uri) {
                        return uri !== null;
                    });
                    callback(null, spotifyURIs);
                }
            }
        };
        xhr.open('GET', url);
        xhr.timeout = EchoNestAPI.timeout;
        xhr.send();
    };
    

    (function() {
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var params = getHashParams();

        var accessToken = params.access_token;
        //var state = params.state;
        //var storedState = localStorage.getItem(stateKey);

        if (accessToken) {
            history.pushState(null, null, '/');

            var status = document.getElementById('status');
            status.innerHTML = 'Creating your playlist...';

            var artist = localStorage.getItem('artist');
            var artistQuery = encodeURIComponent(artist);
            var playlistName = 'based on: ' + artist;

            SpotifyAPI.getUserId(accessToken, function(error, userId) {
                if (error) status.innerHTML = error;
                    else EchoNestAPI.getArtistRadio(artistQuery, 20, function(error, spotifyURIs) {
                    if (error) status.innerHTML = error;
                    else SpotifyAPI.createPlaylist(accessToken, userId, playlistName, function(error, playlistId) {
                        if (error) status.innerHTML = error;
                        else SpotifyAPI.addTracksToPlaylist(accessToken, userId, playlistId, spotifyURIs, function(error) {
                            if (error) status.innerHTML = error;
                            else reportSuccess(userId, playlistId);
                        });
                    });
                });
            });

            function reportSuccess(userId, playlistId) {
                status.innerHTML = 'Success! View your playlist '
                                    + '<a href="https://open.spotify.com/user/' + userId 
                                    + '/playlist/' + playlistId 
                                    + '" target="_blank">here</a> or in the Spotify app.';
            }
        }
    })();

</script>
</html>
